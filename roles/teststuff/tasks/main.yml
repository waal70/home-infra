---
# tasks file for teststuff
- name: Get current filesystem features
  command: debugfs -R features {{ root_partition }}
  register: results

- name: Create variable for filesystem-check
  set_fact:
    fs_features: "{{ results.stdout_lines }}"
- debug:
    var: fs_features

- name: Execute super-dangerous commands
  ansible.builtin.raw: echo u > /proc/sysrq-trigger && echo s > /proc/sysrq-trigger && sleep 2 && tune2fs -O ^has_journal {{ root_partition }} && sleep 2 && e2fsck -fy {{ root_partition }} && echo s > /proc/sysrq-trigger && echo b > /proc/sysrq-trigger
  become: true

- ansible.builtin.meta: clear_host_errors

- name: Wait for system to become reachable
  wait_for_connection:
    delay: 20
    timeout: 60
  when: fs_features is search("has_journal")

- name: Get current filesystem features
  command: debugfs -R features {{ root_partition }}
  register: resultsafter

- name: Create variable for filesystem-check
  set_fact:
    fs_features: "{{ resultsafter.stdout_lines }}"
- debug:
    var: fs_features