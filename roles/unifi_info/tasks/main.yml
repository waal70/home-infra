---
# tasks file for unifi_info
# The API is not officially documented. This module is based upon:
# https://ubntwiki.com/products/software/unifi-controller/api

- name: Generate authentication token
  ansible.builtin.uri:
    url: "{{ controller_login }}"
    method: POST
    return_content: true
    body_format: json
    body:
      username: "{{ controller_username }}"
      password: "{{ controller_password }}"
      remember: "true"
    validate_certs: false
  register: auth_token

- name: Get info on active stations (ie. connected client devices, currently holding an IP-address)
  ansible.builtin.uri:
    url: "{{ controller_api }}/s/{{ controller_site }}/stat/sta"
    method: GET
    headers:
      Cookie: "{{ auth_token.cookies_string }}"
    return_content: true
    validate_certs: false
  register: response

- name: Create variable to hold the list of active client devices
  ansible.builtin.set_fact:
    livelist: "{{ response.json | default({'data': {}}) | community.general.json_query('data[*].{mac: mac,ansible_host: ip,hostname: hostname, oui: oui}') }}"

- name: Debug intermediate
  ansible.builtin.debug:
    msg: "{{ dict(livelist) | combine(maclist, recursive=True)  }}"
