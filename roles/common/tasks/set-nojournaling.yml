---
- name: Get current filesystem features
  command: debugfs -R features {{ root_partition }}
  register: results

- name: Create variable for filesystem-check
  set_fact:
    fs_features: "{{ results.stdout_lines }}"
- debug:
    var: fs_features

- name: Create the force journal script
  ansible.builtin.template:
    src: ./templates/force_journal.sh.j2
    dest: /tmp/force_journal.sh
    mode: '0777'

- name: Run the script
  command: /tmp/force_journal.sh
  async: 60
  poll: 0
  become: true
  become_user: root
  when: "'has_journal' in fs_features"

- ansible.builtin.meta: clear_host_errors

- name: Wait for system to become reachable
  wait_for_connection:
    delay: 20
    timeout: 60



