---
- name: Check current powersave governor
  ansible.builtin.command: cat /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor
  register: governor_output
  failed_when: "governor_output.rc not in [ 0, 1 ]"

- name: Create variable for governor check
  set_fact:
    cpu_governors: "{{ governor_output.stdout_lines }}"
- debug:
    var: cpu_governors

- name: Ensure cpufrequtils is installed
  ansible.builtin.apt:
    name: cpufrequtils
    state: present
  
- name: Set powersave governor to powersave if currently other setting
  ansible.builtin.template:
    src: etc/default/cpufrequtils.j2
    dest: /etc/default/cpufrequtils
    owner: root
    group: root
    mode: 0644
  when: cpu_governors is search("performance")
  
